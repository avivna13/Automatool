# üîó Merged App Intelligence Automation Specification

## **Overview**
Create an automation that combines SensorTower app metadata with Google Play reviews data to generate a comprehensive app intelligence report. This tool merges two existing data sources into a unified intelligence document for enhanced app analysis.

## **Functional Requirements**

### **Input Parameters**
- **package_name** (str): Android app package name (e.g., "com.example.app")
- **output_directory** (str): Target directory for output files
- **verbose** (bool): Enable debug output and detailed logging

### **Core Functionality**
1. **Fetch SensorTower Data**: Leverage existing `sensor_scraper.py` to get app metadata as formatted string
2. **Fetch Reviews Data**: Use existing `run_reviews_with_parsing.py` to get reviews summary as formatted string  
3. **Merge Data**: Combine both data sources into a unified intelligence report
4. **Output Generation**: Write merged report to output directory with proper formatting

## **Data Sources Integration**

### **SensorTower Data Source** (via `sensor_scraper.py`)
- **Primary Function**: `fetch_app_data(package_name)` ‚Üí returns dict
- **Text Conversion**: `parse_to_text(data, google_play_url)` ‚Üí returns formatted string
- **Content Includes**: 
  - App basic information (name, publisher, category)
  - Release and version information
  - Ratings and financial data
  - Availability and country distribution
  - Version history

### **Reviews Data Source** (via `run_reviews_with_parsing.py`)
- **Primary Function**: `run_reviews_with_parsing(package_name, output_directory, verbose)` ‚Üí returns formatted string
- **Content Includes**:
  - Reviews summary with country analysis
  - User feedback and sentiment
  - Country distribution of reviews
  - Individual review details

## **Output Specifications**

### **Primary Output File**
- **Filename**: `app_intelligence_report.txt`
- **Location**: `{output_directory}/app_intelligence_report.txt`
- **Format**: UTF-8 encoded text with structured sections
- **Encoding**: UTF-8 to support international characters and emojis

### **Report Structure Template**
```
===============================================
          APP INTELLIGENCE REPORT
===============================================
Package: {package_name}
Generated: {timestamp}
===============================================

[SENSOR TOWER APP METADATA]
{sensor_tower_formatted_data}

===============================================

[GOOGLE PLAY REVIEWS ANALYSIS]  
{reviews_formatted_data}

===============================================
Report generated by Aviv Automatool
```

## **Implementation Strategy**

### **New Module Location**
**File**: `automatool/automatool/src/scripts/automations/merge_app_intelligence.py`

### **Primary Function Signature**
```python
def merge_app_intelligence(package_name: str, output_directory: str, verbose: bool = False) -> str:
    """
    Merge SensorTower app data with Google Play reviews into comprehensive report.
    
    Args:
        package_name (str): Android package name to analyze
        output_directory (str): Directory for output files
        verbose (bool): Enable verbose logging
        
    Returns:
        str: Path to generated report file, or None if failed
        
    Raises:
        No exceptions raised - function handles all errors gracefully
    """
```

### **Implementation Details**

#### **Step 1: Data Acquisition**
```python
from datetime import datetime
import os

# Import existing automation modules
from scripts.automations.sensor_scraper import fetch_app_data, parse_to_text, generate_google_play_url
from scripts.automations.run_reviews_with_parsing import run_reviews_with_parsing

def merge_app_intelligence(package_name: str, output_directory: str, verbose: bool = False) -> str:
    if verbose:
        print(f"[DEBUG] Starting app intelligence merge for: {package_name}")
        print(f"[DEBUG] Output directory: {output_directory}")
    
    # Initialize data containers
    sensor_text = None
    reviews_text = None
    
    # Fetch SensorTower data
    try:
        if verbose:
            print("[DEBUG] Fetching SensorTower app data...")
        
        sensor_data = fetch_app_data(package_name)
        if sensor_data:
            app_id = sensor_data.get('app_id', '')
            country = sensor_data.get('country', 'US') 
            google_play_url = generate_google_play_url(app_id, country)
            sensor_text = parse_to_text(sensor_data, google_play_url)
            
            if verbose:
                print("[DEBUG] ‚úÖ SensorTower data retrieved successfully")
        else:
            if verbose:
                print("[DEBUG] ‚ùå SensorTower data retrieval failed")
                
    except Exception as e:
        if verbose:
            print(f"[DEBUG] ‚ùå SensorTower error: {e}")
    
    # Fetch Reviews data  
    try:
        if verbose:
            print("[DEBUG] Fetching Google Play reviews data...")
        
        reviews_text = run_reviews_with_parsing(package_name, output_directory, verbose)
        
        if reviews_text and not reviews_text.startswith("Error:"):
            if verbose:
                print("[DEBUG] ‚úÖ Reviews data retrieved successfully")
        else:
            if verbose:
                print("[DEBUG] ‚ùå Reviews data retrieval failed or returned error")
                
    except Exception as e:
        if verbose:
            print(f"[DEBUG] ‚ùå Reviews error: {e}")
```

#### **Step 2: Data Merging and Formatting**
```python
    # Create unified report structure
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    report_sections = [
        "=" * 47,
        " " * 10 + "APP INTELLIGENCE REPORT" + " " * 10,
        "=" * 47,
        f"Package: {package_name}",
        f"Generated: {timestamp}",
        "=" * 47,
        "",
        "[SENSOR TOWER APP METADATA]",
        sensor_text if sensor_text else "‚ùå SensorTower data unavailable - API may be down or package not found",
        "",
        "=" * 47,
        "",
        "[GOOGLE PLAY REVIEWS ANALYSIS]",
        reviews_text if reviews_text and not reviews_text.startswith("Error:") else "‚ùå Reviews data unavailable - scraping may have failed",
        "",
        "=" * 47,
        "Report generated by Aviv Automatool"
    ]

    merged_report = "\n".join(report_sections)
```

#### **Step 3: File Output and Error Handling**
```python
    # Generate output file path
    output_file = os.path.join(output_directory, "app_intelligence_report.txt")
    
    if verbose:
        print(f"[DEBUG] Writing report to: {output_file}")
        print(f"[DEBUG] Report length: {len(merged_report)} characters")

    try:
        # Ensure output directory exists
        os.makedirs(output_directory, exist_ok=True)
        
        # Write the merged report
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(merged_report)
        
        print(f"‚úÖ App intelligence report saved: {output_file}")
        
        if verbose:
            print(f"[DEBUG] ‚úÖ Report successfully written to disk")
            
        return output_file
        
    except PermissionError:
        error_msg = f"‚ùå ERROR: Permission denied writing to: {output_file}"
        print(error_msg)
        return None
        
    except Exception as e:
        error_msg = f"‚ùå ERROR: Failed to save report: {e}"
        print(error_msg)
        if verbose:
            print(f"[DEBUG] Exception details: {type(e).__name__}: {e}")
        return None
```

### **Error Handling Strategy**
1. **Graceful Degradation**: If one data source fails, include error message in that section but continue
2. **Input Validation**: Check package_name format and output_directory accessibility  
3. **Timeout Protection**: Inherit timeout handling from `run_reviews_with_parsing`
4. **Resource Tracking**: Compatible with existing `GlobalResourceTracker`
5. **Silent Failures**: Never crash the main automation due to intelligence report issues

### **Integration into Main Automation (`automatool.py`)**

#### **Import Addition**
```python
### AUTOMATIONS IMPORTS ###
from scripts.automations.init import validate_files
from scripts.automations.launch_jadx import launch_jadx_gui
from scripts.automations.launch_vscode import launch_vscode
from scripts.automations.run_reviews_with_parsing import run_reviews_with_parsing
from scripts.automations.merge_app_intelligence import merge_app_intelligence  # NEW
```

#### **Integration Point**
**Location**: After line 178 (after reviews scraping, before Frida scripts)

```python
    # Run reviews scraper and parser with threading
    reviews = run_reviews_with_parsing(package_name, args.directory, args.verbose)
    
    # Track reviews files
    reviews_json_path = os.path.join(args.directory, "reviews.json")
    reviews_summary_path = os.path.join(args.directory, "reviews_summary.txt")
    
    # Track reviews files with error handling
    try:
        if os.path.exists(reviews_json_path):
            resource_tracker.add_file(reviews_json_path)
        if os.path.exists(reviews_summary_path):
            resource_tracker.add_file(reviews_summary_path)
    except Exception as e:
        print(f"‚ùå ERROR: Failed to track reviews files: {e}")
        if args.verbose:
            print(f"[DEBUG] Exception details: {type(e).__name__}: {e}")

    # NEW: Generate merged app intelligence report
    app_intelligence_report_path = merge_app_intelligence(package_name, args.directory, args.verbose)
    if app_intelligence_report_path:
        try:
            resource_tracker.add_file(app_intelligence_report_path)
        except Exception as e:
            print(f"‚ùå ERROR: Failed to track app intelligence report: {e}")
            if args.verbose:
                print(f"[DEBUG] Exception details: {type(e).__name__}: {e}")

    # Copy Frida scripts to target directory
    copy_frida_scripts(args.directory, args.verbose)
```

## **Dependencies**

### **Internal Dependencies**
- `scripts.automations.sensor_scraper` (existing)
- `scripts.automations.run_reviews_with_parsing` (existing)

### **Standard Library Dependencies**
- `os` - File system operations
- `datetime` - Timestamp generation

### **No New External Dependencies**
All functionality uses existing, tested components.

## **Testing Strategy**

### **Unit Testing Scenarios**
1. **Valid Package**: Test with known package name (e.g., "com.whatsapp")
2. **Invalid Package**: Test with non-existent package name
3. **Network Failures**: Test with network connectivity issues
4. **Partial Data**: Test when only one data source succeeds
5. **File System Issues**: Test with read-only output directories

### **Integration Testing**
1. **Full Workflow**: Verify integration with main `automatool.py`
2. **Resource Tracking**: Ensure file is properly tracked for cleanup
3. **Performance**: Verify reasonable execution time (< 60 seconds)

### **Expected Test Results**
```bash
# Valid package test
python -m pytest test_merge_app_intelligence.py::test_valid_package
# Should create app_intelligence_report.txt with both sections populated

# Invalid package test  
python -m pytest test_merge_app_intelligence.py::test_invalid_package
# Should create report with error messages in both sections

# Integration test
python automatool.py -d "/test/dir" -f "test.apk" --verbose
# Should include "‚úÖ App intelligence report saved" in output
```

## **Expected Output Format**

### **Successful Merge Example**
```
===============================================
          APP INTELLIGENCE REPORT
===============================================
Package: com.whatsapp
Generated: 2025-01-15 14:30:25
===============================================

[SENSOR TOWER APP METADATA]

============================================================
                    APP INFORMATION                     
============================================================
 üì± App: WhatsApp Messenger (com.whatsapp)
 üè¢ Publisher: WhatsApp LLC
 üè∑Ô∏è Category: Communication
 üåç OS: Android
 üìù Description: Simple. Reliable. Secure.
 üîó Google Play: https://play.google.com/store/apps/details?id=com.whatsapp&gl=US

---------------------- Release & Version ---------------------
 üóìÔ∏è Worldwide Release: 2009-05-03
 üì¶ Current Version: 2.24.1.78 (Released: 2025-01-10)
 ‚öôÔ∏è Minimum OS: 4.1
 üìè File Size: 65MB

---------------------- Ratings & Financials -------------------
 ‚≠ê Rating: 4.12 stars (15,234,567 reviews)
 üí∞ In-App Purchases: None
 üìà Total Installs: 5,000,000,000+

-------------------------- Availability ------------------------
 üåç Top Countries: US, IN, BR, ID, PK and 195 more...
 ‚úÖ Available in 180 countries, including: US, GB, DE, FR, JP...

----------------------- Version History ----------------------
  - Version 2.24.1.78   | Released on: 2025-01-10
  - Version 2.24.1.77   | Released on: 2025-01-03
  - Version 2.23.25.84  | Released on: 2024-12-20
  - Version 2.23.25.83  | Released on: 2024-12-15
  - Version 2.23.24.82  | Released on: 2024-12-10
  ... and 245 older versions.
============================================================

===============================================

[GOOGLE PLAY REVIEWS ANALYSIS]
=== REVIEWS SUMMARY ===
Most Reviews From: US (1,234 reviews - 45.2% of total)

Country Distribution:
- US: 1,234 reviews (45.2%)
- IN: 567 reviews (20.8%)
- BR: 345 reviews (12.6%)
- GB: 234 reviews (8.6%)
- DE: 123 reviews (4.5%)

1. User: John_Smith | Country: US
   Review: Great app for messaging, very reliable and secure

2. User: Maria_Silva | Country: BR  
   Review: Excellent application, I use it every day

3. User: Raj_Patel | Country: IN
   Review: Best messaging app available, highly recommended

===============================================
Report generated by Aviv Automatool
```

### **Partial Failure Example**
```
===============================================
          APP INTELLIGENCE REPORT
===============================================
Package: com.nonexistent.app
Generated: 2025-01-15 14:30:25
===============================================

[SENSOR TOWER APP METADATA]
‚ùå SensorTower data unavailable - API may be down or package not found

===============================================

[GOOGLE PLAY REVIEWS ANALYSIS]
‚ùå Reviews data unavailable - scraping may have failed

===============================================
Report generated by Aviv Automatool
```

## **Key Benefits**

### **Technical Benefits**
‚úÖ **Unified Intelligence**: Single file containing both technical and user sentiment data  
‚úÖ **Minimal Complexity**: Reuses existing, tested components  
‚úÖ **Consistent Integration**: Follows established automation patterns  
‚úÖ **Error Resilient**: Graceful handling of data source failures  
‚úÖ **Resource Tracked**: Compatible with cleanup automation  
‚úÖ **No New Dependencies**: Uses only existing libraries and modules  

### **Business Benefits**
‚úÖ **Comprehensive Analysis**: Combines technical metadata with user feedback  
‚úÖ **Time Saving**: Automated generation eliminates manual data collection  
‚úÖ **Standardized Format**: Consistent report structure across all analyses  
‚úÖ **Historical Tracking**: Reports are saved and tracked for future reference  

## **File Locations**

### **Implementation Files**
- **New Module**: `automatool/automatool/src/scripts/automations/merge_app_intelligence.py`
- **Integration Point**: `automatool/automatool/src/automatool.py` (lines ~185-195)

### **Output Files**
- **Primary Output**: `{output_directory}/app_intelligence_report.txt`
- **Dependency Files**: 
  - `{output_directory}/reviews.json` (created by reviews automation)
  - `{output_directory}/reviews_summary.txt` (created by reviews automation)
  - `{output_directory}/sensortower.json` (created by sensor_scraper)

## **Implementation Steps**

### **Step 1: Create New Module**
- Create `merge_app_intelligence.py` in automations directory
- Implement main function with error handling
- Add comprehensive logging and verbose output

### **Step 2: Integrate into Main Workflow**  
- Add import statement to `automatool.py`
- Insert function call after reviews processing
- Add resource tracking for generated report

### **Step 3: Testing**
- Test with known package names
- Verify error handling with invalid inputs
- Confirm resource tracking integration

### **Step 4: Documentation**
- Update main README if needed
- Add usage examples
- Document expected output formats

## **Limitations (By Design)**

### **Acceptable Limitations**
- **Sequential Processing**: Processes data sources one at a time (acceptable for reliability)
- **No Caching**: Each run fetches fresh data (ensures up-to-date information)
- **Single Package**: Processes one package at a time (matches existing workflow)
- **Text Format Only**: Outputs text format only (sufficient for current needs)

### **Future Enhancement Opportunities**
- Add JSON output format option
- Implement parallel data fetching
- Add data caching mechanism
- Support batch package processing

This specification provides a robust, well-integrated solution that leverages existing automation components to deliver comprehensive app intelligence reporting with minimal complexity and maximum reliability.
