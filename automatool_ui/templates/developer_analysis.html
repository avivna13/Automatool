<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer APK Analysis - AutomatoolUI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2>üîç Developer APK Analysis</h2>
                <p class="text-muted">Extract hardcoded API keys from APK files and maintain a centralized developer database.</p>
            </div>
        </div>

        <!-- Status Alert -->
        <div id="status-alert" class="alert" style="display: none;" role="alert">
            <span id="status-message"></span>
        </div>

        <!-- Analysis Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üìã Analysis Configuration</h5>
            </div>
            <div class="card-body">
                <!-- Current Setup Info -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>üì± APK File:</strong>
                        <span class="text-muted">{{ state.APK_PATH or 'Not configured' }}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>üìÅ Output Directory:</strong>
                        <span class="text-muted">{{ state.OUTPUT_DIR or 'Not configured' }}</span>
                    </div>
                </div>

                <hr>

                <!-- Input Form -->
                <form id="developer-analysis-form">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group mb-3">
                                <label for="developer-name" class="form-label">
                                    üè∑Ô∏è Developer Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="developer-name" 
                                       placeholder="Enter unique developer identifier (e.g., MalwareDev, TestApp)"
                                       pattern="[a-zA-Z0-9_-]+"
                                       title="Only alphanumeric characters, underscores, and hyphens allowed"
                                       required>
                                <div class="form-text">
                                    Use alphanumeric characters, underscores, and hyphens only. No spaces or special characters.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="force-overwrite">
                                    <label class="form-check-label" for="force-overwrite">
                                        üîÑ Force overwrite existing entry
                                    </label>
                                </div>
                                <div class="form-text">
                                    Check to overwrite if developer already exists in database.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <button type="submit" 
                                    class="btn btn-primary btn-lg"
                                    id="start-analysis-btn"
                                    {% if not state.setup_complete %}disabled{% endif %}>
                                üöÄ Start Analysis
                            </button>
                            
                            {% if not state.setup_complete %}
                            <div class="text-danger mt-2">
                                ‚ö†Ô∏è Please complete setup (upload APK or configure manual setup) before running analysis.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progress-section" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">‚è≥ Analysis Progress</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: 100%">
                        Analyzing...
                    </div>
                </div>
                <p class="mb-3" id="progress-message">Starting developer APK analysis...</p>
                
                <!-- Live Output Display -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">üìã Live Output</h6>
                    </div>
                    <div class="card-body">
                        <pre id="live-output" style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; font-size: 0.85em; white-space: pre-wrap;">Waiting for output...</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">üìä Analysis Results</h5>
            </div>
            <div class="card-body">
                <div id="results-content">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="row">
            <div class="col-12">
                <button class="btn btn-secondary" onclick="goBackToMain()">
                    ‚Üê Back to Main Interface
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Page-specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('developer-analysis-form');
            const developerNameInput = document.getElementById('developer-name');
            
            // Form validation
            developerNameInput.addEventListener('input', function() {
                const value = this.value;
                const isValid = /^[a-zA-Z0-9_-]*$/.test(value);
                
                if (!isValid && value) {
                    this.setCustomValidity('Only alphanumeric characters, underscores, and hyphens allowed');
                } else {
                    this.setCustomValidity('');
                }
            });
            
            // Form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                handleDeveloperAnalysis();
            });
        });

        function handleDeveloperAnalysis() {
            const developerName = document.getElementById('developer-name').value.trim();
            const force = document.getElementById('force-overwrite').checked;
            
            if (!developerName) {
                showAlert('danger', 'Please enter a developer name');
                return;
            }
            
            // Show progress
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('start-analysis-btn').disabled = true;
            
            // Update progress message
            document.getElementById('progress-message').textContent = 'Starting developer APK analysis...';
            
            // Make API call
            fetch('/api/action/developer-apk-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    developer_name: developerName,
                    force: force
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Process started successfully, now poll for status and output
                    document.getElementById('progress-message').textContent = 'Analysis in progress... Monitoring output...';
                    startProcessMonitoring(developerName);
                } else {
                    // Failed to start
                    document.getElementById('progress-section').style.display = 'none';
                    document.getElementById('start-analysis-btn').disabled = false;
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                document.getElementById('progress-section').style.display = 'none';
                document.getElementById('start-analysis-btn').disabled = false;
                showAlert('danger', 'Network error: ' + error.message);
            });
        }

        let statusPollingInterval = null;

        function startProcessMonitoring(developerName) {
            // Clear any existing polling
            if (statusPollingInterval) {
                clearInterval(statusPollingInterval);
            }
            
            // Start polling for status updates
            statusPollingInterval = setInterval(() => {
                pollProcessStatus(developerName);
            }, 1000); // Poll every second
            
            // Initial poll
            pollProcessStatus(developerName);
        }

        function pollProcessStatus(developerName) {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const status = data.status;
                    const log = data.log || [];
                    
                    // Update live output
                    updateLiveOutput(log);
                    
                    // Check if process completed
                    if (status === 'completed') {
                        // Process completed successfully
                        clearInterval(statusPollingInterval);
                        showProcessCompleted(developerName, true);
                    } else if (status === 'error') {
                        // Process failed
                        clearInterval(statusPollingInterval);
                        showProcessCompleted(developerName, false);
                    } else if (status === 'ready') {
                        // Process finished (either success or error)
                        clearInterval(statusPollingInterval);
                        // Check the last log entries to determine success/failure
                        const lastLogEntry = log.length > 0 ? log[log.length - 1] : '';
                        const isSuccess = lastLogEntry.includes('‚úÖ') || lastLogEntry.includes('completed successfully');
                        showProcessCompleted(developerName, isSuccess);
                    }
                    // If status is 'running', continue polling
                })
                .catch(error => {
                    console.error('Error polling status:', error);
                });
        }

        function updateLiveOutput(logEntries) {
            const outputElement = document.getElementById('live-output');
            if (outputElement && logEntries.length > 0) {
                // Join all log entries and display them
                const outputText = logEntries.join('\n');
                outputElement.textContent = outputText;
                
                // Auto-scroll to bottom
                outputElement.scrollTop = outputElement.scrollHeight;
            }
        }

        function showProcessCompleted(developerName, isSuccess) {
            // Hide progress section
            document.getElementById('progress-section').style.display = 'none';
            
            // Re-enable the button
            document.getElementById('start-analysis-btn').disabled = false;
            
            // Show results
            document.getElementById('results-section').style.display = 'block';
            
            if (isSuccess) {
                // Parse the log output to extract developer details
                const outputElement = document.getElementById('live-output');
                const logOutput = outputElement ? outputElement.textContent : '';
                
                const developerDetails = parseDeveloperDetails(logOutput, developerName);
                
                if (developerDetails) {
                    showAlert('success', `Developer details retrieved successfully for: ${developerName}`);
                    document.getElementById('results-content').innerHTML = generateDeveloperDetailsHTML(developerDetails);
                } else {
                    showAlert('success', `Developer APK analysis completed successfully for: ${developerName}`);
                    document.getElementById('results-content').innerHTML = `
                        <div class="alert alert-success">
                            <h6>‚úÖ Analysis Completed Successfully</h6>
                            <p>Developer APK analysis has been completed for: <strong>${developerName}</strong></p>
                            <p>Results have been saved to the developers database in the project root directory.</p>
                            <small class="text-muted">
                                Check the developers.json file for extracted API keys and analysis results.
                            </small>
                        </div>
                    `;
                }
            } else {
                showAlert('danger', `Developer APK analysis failed for: ${developerName}`);
                document.getElementById('results-content').innerHTML = `
                    <div class="alert alert-danger">
                        <h6>‚ùå Analysis Failed</h6>
                        <p>Developer APK analysis failed for: <strong>${developerName}</strong></p>
                        <p>Please check the output above for error details and try again.</p>
                        <small class="text-muted">
                            Make sure the APK file is valid and all dependencies are properly configured.
                        </small>
                    </div>
                `;
            }
        }

        function parseDeveloperDetails(logOutput, developerName) {
            try {
                const lines = logOutput.split('\n');
                let isInDetailsSection = false;
                let isInApiKeysSection = false;
                let currentApiType = null;
                
                const details = {
                    developer: developerName,
                    totalKeys: 0,
                    categories: 0,
                    apiKeys: {},
                    summary: {},
                    isExisting: false,
                    isNewAnalysis: false
                };
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Check if developer already exists
                    if (line.includes(`Developer '${developerName}' found in database`) || 
                        line.includes("EXISTING DEVELOPER DETAILS")) {
                        details.isExisting = true;
                    }
                    
                    // Check if this is a new analysis
                    if (line.includes("ANALYSIS COMPLETED SUCCESSFULLY") && 
                        !details.isExisting) {
                        details.isNewAnalysis = true;
                    }
                    
                    // Parse total keys and categories
                    if (line.includes('üìä Total API Keys:')) {
                        const match = line.match(/üìä Total API Keys: (\d+)/);
                        if (match) details.totalKeys = parseInt(match[1]);
                    }
                    
                    if (line.includes('üîë API Key Categories:')) {
                        const match = line.match(/üîë API Key Categories: (\d+)/);
                        if (match) details.categories = parseInt(match[1]);
                    }
                    
                    // Parse API keys by type summary
                    if (line.includes('üîë API KEYS BY TYPE:')) {
                        isInDetailsSection = true;
                        continue;
                    }
                    
                    if (isInDetailsSection && line.includes('üìã DETAILED API KEYS:')) {
                        isInDetailsSection = false;
                        isInApiKeysSection = true;
                        continue;
                    }
                    
                    // Parse summary counts
                    if (isInDetailsSection && line.includes('‚Ä¢')) {
                        const match = line.match(/‚Ä¢ ([^:]+): (\d+) key\(s\)/);
                        if (match) {
                            details.summary[match[1]] = parseInt(match[2]);
                        }
                    }
                    
                    // Parse detailed API keys
                    if (isInApiKeysSection) {
                        if (line.includes(':') && !line.includes('.')) {
                            // This is an API type header
                            currentApiType = line.replace(':', '').trim();
                            details.apiKeys[currentApiType] = [];
                        } else if (line.match(/^\d+\./)) {
                            // This is an API key entry
                            const keyMatch = line.match(/^\d+\.\s+(.+)$/);
                            if (keyMatch && currentApiType) {
                                details.apiKeys[currentApiType].push(keyMatch[1]);
                            }
                        } else if (line.includes('==========')) {
                            // End of detailed section
                            isInApiKeysSection = false;
                        }
                    }
                }
                
                // Return details if we found meaningful data
                if (details.totalKeys > 0 || details.isExisting || details.isNewAnalysis) {
                    return details;
                }
                
                return null;
            } catch (error) {
                console.error('Error parsing developer details:', error);
                return null;
            }
        }

        function generateDeveloperDetailsHTML(details) {
            const statusClass = details.isExisting ? 'alert-info' : 'alert-success';
            const statusIcon = details.isExisting ? 'üìã' : '‚úÖ';
            const statusTitle = details.isExisting ? 'Developer Found in Database' : 'Analysis Completed Successfully';
            const statusMessage = details.isExisting ? 
                'This developer already exists in the database. Use the "Force overwrite" option to re-analyze.' :
                'New developer analysis completed and saved to database.';
            
            let html = `
                <div class="${statusClass}">
                    <h6>${statusIcon} ${statusTitle}</h6>
                    <p><strong>Developer:</strong> ${details.developer}</p>
                    <p>${statusMessage}</p>
                </div>
            `;
            
            if (details.totalKeys > 0) {
                html += `
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">üìä API Keys Summary</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>üìä Total API Keys:</strong> <span class="badge bg-primary">${details.totalKeys}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>üîë Categories:</strong> <span class="badge bg-secondary">${details.categories}</span>
                                </div>
                            </div>
                `;
                
                // Add summary by type
                if (Object.keys(details.summary).length > 0) {
                    html += '<h6>üîë API Keys by Type:</h6><div class="row">';
                    for (const [type, count] of Object.entries(details.summary)) {
                        html += `
                            <div class="col-md-6 mb-2">
                                <span class="text-muted">‚Ä¢ ${type}:</span> 
                                <span class="badge bg-info">${count} key(s)</span>
                            </div>
                        `;
                    }
                    html += '</div>';
                }
                
                html += '</div></div>';
                
                // Add detailed API keys if available
                if (Object.keys(details.apiKeys).length > 0) {
                    html += `
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">üîç Detailed API Keys</h6>
                            </div>
                            <div class="card-body">
                    `;
                    
                    for (const [type, keys] of Object.entries(details.apiKeys)) {
                        if (keys && keys.length > 0) {
                            html += `
                                <div class="mb-3">
                                    <h6 class="text-primary">${type}:</h6>
                                    <ul class="list-group list-group-flush">
                            `;
                            
                            keys.forEach((key, index) => {
                                html += `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <code style="font-size: 0.9em;">${key}</code>
                                        <span class="badge bg-light text-dark">${index + 1}</span>
                                    </li>
                                `;
                            });
                            
                            html += '</ul></div>';
                        }
                    }
                    
                    html += '</div></div>';
                }
            }
            
            return html;
        }

        function checkAnalysisResults(developerName) {
            // This function is now replaced by the monitoring system
            // Kept for backward compatibility but not used
        }

        function showAlert(type, message) {
            const alertDiv = document.getElementById('status-alert');
            const messageSpan = document.getElementById('status-message');
            
            alertDiv.className = `alert alert-${type}`;
            messageSpan.textContent = message;
            alertDiv.style.display = 'block';
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 5000);
            }
        }

        function navigateToDeveloperAnalysis() {
            window.location.href = '/developer-analysis';
        }

        function goBackToMain() {
            // Clean up polling interval before navigating
            if (statusPollingInterval) {
                clearInterval(statusPollingInterval);
            }
            window.location.href = '/';
        }

        // Clean up polling when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (statusPollingInterval) {
                clearInterval(statusPollingInterval);
            }
        });
    </script>
</body>
</html>
